name: Release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:

jobs:
  tests:
    name: Lint and test (Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2

      - name: cargo fmt
        run: cargo fmt --all --check

      - name: cargo clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: cargo test
        run: cargo test --locked

  build:
    name: Build (${{ matrix.os }})
    needs: tests
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Ensure python3 alias (Windows)
        if: matrix.os == 'windows-latest'
        shell: pwsh
        run: |
          $python = (Get-Command python).Source
          if (-not $python) {
            throw "python not found on PATH"
          }
          $shim = "$env:RUNNER_TEMP\python-shim"
          New-Item -ItemType Directory -Force -Path $shim | Out-Null
          Copy-Item $python "$shim\python3.exe"
          Add-Content -Path $env:GITHUB_PATH -Value $shim

      - name: Cache cargo builds
        uses: Swatinem/rust-cache@v2

      - name: cargo test
        run: cargo test --locked

      - name: Install musl target (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: rustup target add x86_64-unknown-linux-musl

      - name: Install musl tools (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: sudo apt-get update && sudo apt-get install -y musl-tools

      - name: cargo build --release (target default)
        run: cargo build --release --locked

      - name: cargo build --release (musl)
        if: matrix.os == 'ubuntu-latest'
        run: cargo build --release --locked --target x86_64-unknown-linux-musl

      - name: Package archive
        shell: bash
        run: |
          set -euo pipefail
          EXT=""
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            EXT=".exe"
          fi
          TARGET_DIR="target/release"
          BIN="sv-mint${EXT}"
          if [[ "${{ matrix.os }}" == "ubuntu-latest" ]]; then
            TARGET_DIR="target/x86_64-unknown-linux-musl/release"
          fi
          DIST="dist"
          rm -rf "${DIST}"
          mkdir -p "${DIST}"
          cp "${TARGET_DIR}/${BIN}" "${DIST}/${BIN}"
          cp -R docs "${DIST}/docs"
          cp -R plugins "${DIST}/plugins"
          cp sv-mint.toml "${DIST}/sv-mint.toml"
          cp README.md "${DIST}/README.md"
          cp LICENSE "${DIST}/LICENSE"
          cp CHANGELOG.md "${DIST}/CHANGELOG.md"
          ARCHIVE="sv-mint-${{ matrix.os }}-${{ github.ref_name }}"
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            (cd "${DIST}" && 7z a "../${ARCHIVE}.zip" . >/dev/null)
            ARCHIVE_PATH="${ARCHIVE}.zip"
          else
            tar -czf "${ARCHIVE}.tar.gz" -C "${DIST}" .
            ARCHIVE_PATH="${ARCHIVE}.tar.gz"
          fi
          export ARCHIVE_PATH
          python - <<'PY'
          import hashlib
          import os
          import pathlib

          path = pathlib.Path(os.environ["ARCHIVE_PATH"])
          digest = hashlib.sha256(path.read_bytes()).hexdigest()
          pathlib.Path("checksums.txt").write_text(f"{digest}  {path.name}\n")
          PY
          ls -al

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: sv-mint-${{ matrix.os }}
          path: |
            *.tar.gz
            *.zip
            checksums.txt

  release:
    name: Publish GitHub Release
    needs: build
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: release
          merge-multiple: true

      - name: Create release
        uses: softprops/action-gh-release@v1
        with:
          files: release/**
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
